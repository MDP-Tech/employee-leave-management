<!DOCTYPE html>
<html lang="en" data-layout="topnav" data-topbar-color="light" data-menu-color="light">

<head>
    <meta charset="utf-8" />
    <title>Details Page | Shiftwave</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="A fully responsive admin theme which can be used to build CRM, CMS,ERP etc." name="description" />
    <meta content="Techzaa" name="author" />

    <!-- App favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico">

    <!-- Daterangepicker css -->
    <link rel="stylesheet" href="/assets/vendor/daterangepicker/daterangepicker.css">

    <!-- Vector Map css -->
    <link rel="stylesheet" href="/assets/vendor/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.css">

    <!-- Theme Config Js -->
    <script src="/assets/js/config.js"></script>

    <!-- App css -->
    <link href="/assets/css/app.min.css" rel="stylesheet" type="text/css" id="app-style" />

    <!-- Icons css -->
    <link href="/assets/css/icons.min.css" rel="stylesheet" type="text/css" />
    <style>
        .head-fp{
            margin:5px auto;
            font-weight: 900;
            
        }
        .address-hr.biography.updateFields {
    border-bottom: 1px solid #efefef;
    padding: 10px 0;}
    .sp{
        margin: 2px;
    }
    .tp{
        margin: 0px;
    }
    /* .sub-btn-style{
        height: 35px;
        width: 80px;
    } */
    .image-container-file-upload {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
    }

    .image-container-file-upload a {
        text-decoration: none;
    }

    .image-container-file-upload p {
        margin: 0;
    }

    .image-container-file-upload img {
        width: 85%;
        height: 75px;
        margin-right: 10px;
        margin-bottom: 10px;
        border: 0.1px rgb(233 233 233) solid;
    }

    .mrg-style-1{
        margin-top: -31px;
    }
    </style>
</head>

<body>
    <!-- Begin page -->
    <div class="wrapper">

        <%- include('../../includes/employee-header')%>

        <div class="content-page">
            <div class="content">

                <!-- Start Content-->
                <div class="container-fluid">

                    <!-- start page title -->
                    <div class="row">
                        <div class="col-12">
                            <div class="page-title-box">
                                <div class="page-title-right">
                                    <ol class="breadcrumb m-0">
                                        <% result.forEach(leave => { %>
                                            <% if (leave.status === 'pending') { %>
                                                <a>
                                                    <input 
                                                        type="button" 
                                                        value="Delete Leave" 
                                                        class="btn btn-primary btn-sm waves-effect waves-light delete_button" 
                                                        style="margin-right: 2px;">
                                                </a>
                                            <% } %>
                                        <% }); %>
                                        
                                        <a href="javascript:window.history.go(-1);"><input type="button" value="Back" class="btn btn-primary btn-sm waves-effect waves-light"></a>
                                    </ol>
                                </div>

                                <h4 class="page-title">Leave Details</h4>
                            </div>
                        </div>
                    </div>
                    <!-- end page title -->

                    <div class="row" id="table_data">
                        <% result.forEach(leave=> { %>
                            <%= leave.status %>
                        <!-- Striped table start -->
                        <div>
                            <div class="alert alert-danger alert-dismissible fade show" style="display: none;"
                                id="failed_message"><strong>Info: </strong>
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="false">&times;</span>
                                </button>

                            </div>
                            <div class="alert alert-success alert-dismissible fade show" id="sucess_message"
                                style="display: none;"><strong>Info: </strong>
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="address-hr biography updateFields">
                                                <p class="head-fp">Request Id:
                                                </p>
                                                <p class="sp" id="req_id"><%= leave.request_id %> </p>
                                                <p class="tp" style="display:none"></p>
                                            </div>
                                         </div>
                                         <div class="col-md-3">
                                            <div class="address-hr biography updateFields">
                                                <p class="head-fp">Employee Name:
                                                </p>
                                                <p class="sp" id="updateShow-119"><%= leave.fullname %> </p>
                                                <p class="tp" style="display:none"></p>
                                            </div>
                                         </div>
                                         <div class="col-md-3">
                                            <div class="address-hr biography updateFields">
                                                <p class="head-fp">Employee Email:
                                                </p>
                                                <p class="sp" id="updateShow-119"><%= leave.email %></p>
                                                <p class="tp" style="display:none"></p>
                                            </div>
                                         </div>
                                       
                                         <div class="col-md-3">
                                            <div class="address-hr biography updateFields">
                                                <p class="head-fp">Employee id:
                                                </p>
                                                <p class="sp" id="updateShow-119"><%= leave.employee_id %> </p>
                                                <p class="tp" style="display:none"></p>
                                            </div>
                                         </div>
                                         
                                        
                                         <div class="col-md-3">
                                            <div class="address-hr biography updateFields">
                                                <p class="head-fp">Leave Type:
                                                </p>
                                                <p class="sp" id="updateShow-119"> 
                                                    <%= leave.leave_type %>  
                                                    <% if(leave.leave_type == 'Half-Day' || leave.leave_type == 'Emergency/Medical') { %>

                                                       

                                                        <% if(leave.half_day_leave != null ) { %>
                                                               
                                                 --- ><%= leave.half_day_leave %>

                                                 <%}%>
                                                
                                                
                                                    <% } %></p>
                                                <p class="tp" style="display:none"></p>
                                            </div>
                                         </div>
                                         <div class="col-md-3">
                                            <div class="address-hr biography updateFields">
                                                <p class="head-fp">No Of Days
                                                </p>
                                                <p class="sp" id="updateShow-119"><%= leave.no_of_days %> </p>
                                                <p class="tp" style="display:none"></p>
                                            </div>
                                         </div>
                                         <div class="col-md-3">
                                            <div class="address-hr biography updateFields">
                                                <p class="head-fp">Leave From:
                                                </p>
                                                <p class="sp" id="updateShow-119"><% const date=new Date(leave.start_date); const
                                                    start_date=`${date.getDate().toString().padStart(2, '0'
                                                    )}-${(date.getMonth()
                                                        + 1).toString().padStart(2, '0'
                                                        )}-
                                                        ${date.getFullYear()}
                                                    
                                                     `; %>
                                                    <%= start_date %></p>
                                                <p class="tp" style="display:none"></p>
                                            </div>
                                         </div>
                                         <div class="col-md-3">
                                            <div class="address-hr biography updateFields">
                                                <p class="head-fp">Leave Upto:
                                                </p>
                                                <p class="sp" id="updateShow-119"><% const date1=new Date(leave.end_date); const
                                                    end_date=`${date1.getDate().toString().padStart(2, '0'
                                                    )}-${(date1.getMonth()
                                                        + 1).toString().padStart(2, '0'
                                                        )}-${date1.getFullYear()} `; %>
                                                    <%= end_date %></p>
                                                <p class="tp" style="display:none"></p>
                                            </div>
                                         </div>
                                         
                                         
                                         <div class="col-md-3">
                                            <div class="address-hr biography updateFields">
                                                <p class="head-fp">Leave Applied
                                                </p>
                                                <p class="sp" id="updateShow-119">
                                                    <% const date3=new Date(leave.created_at);
                                                     const formattedDate = `${date3.getDate().toString().padStart(2, '0')}-${(date3.getMonth() + 1).toString().padStart(2, '0')}-${date3.getFullYear()}`;

                                                    %>
                                                    <%= formattedDate %>
                                                                                   
                                                <p class="tp" style="display:none"></p>
                                            </div>
                                         </div>
                                         <div class="col-md-3">
                                            <div class="address-hr biography updateFields">
                                                <p class="head-fp">Admin Remark:
                                                </p>
                                                <p class="sp" id="updateShow-119"> <% if(leave.admin_remark== null ) {%>

                                                    "Waiting for Action"

                                                    <%} else {%>

                                                        <%= leave.admin_remark %>
                                                            <%}%></p>
                                                <p class="tp" style="display:none"></p>
                                            </div>
                                         </div>
                                         <div class="col-md-3">
                                            <div class="address-hr biography updateFields">
                                                <p class="head-fp">Admin Action On:
                                                </p>
                                                <p class="sp" id="updateShow-119"><% if(leave.admin_remark_date == null ) {%>

                                                    "NA"

                                                    <%} else {%>
                                                        <%= leave.admin_remark_date %>

                                                            <%}%></p>
                                                            
                                                <p class="tp" style="display:none"></p>
                                            </div>
                                         </div >
                                         <div class="col-md-12">
                                            <div class="address-hr biography updateFields">
                                                <p class="head-fp">Leave Conditions:
                                                </p>
                                                <p class="sp" id="updateShow-119" style="text-align: justify;"><%= leave.Description %></p>
                                                <p class="tp" style="display:none"></p>
                                            </div>
                                         </div>
                                         <div id="file">
                                            <% if(count == 2){ %>
                                            
                                                <div>
                                                    <div class="pt-2">
                                                        <p class="head-fp pb-1">File Upload for Leave</p>
                                                        <%
                                                        var leaveCreatedAt = new Date(leave.created_at);
                                                        var resultDate = new Date(leaveCreatedAt);
                                                        resultDate.setDate(resultDate.getDate() + 5);
                                                      
                                                        // Get the current date
                                                        var currentDate = new Date();
                                                      %>
                                                      
                                                      <% resultDate.toLocaleDateString() %>
                                                      <% currentDate.toLocaleDateString() %> 
                                                      
                                                      <% if (resultDate > currentDate) { %>
                                                        <p class="col-md-6">
                                                          If an employee fails to upload the necessary supporting documents, the leave will be considered
                                                          <b style="color: var(--tz-form-invalid-color);">unscheduled leave</b>. However, HR will be the granting authority.
                                                        </p>
                                                      <div class="col-md-3">
                                                        <input type="file" class="form-control" id="validationCustom04" name="uploaded_document" accept=".pdf, .jpg, .jpeg, .png" multiple="multiple">
                                                        
                                                    </div>
                                                    <div class="invalid-feedback" id="failed-message">
                                                          Please upload a document (PDF, JPG, JPEG, PNG).
                                                        </div>
                                                        <div class="text-danger" id="fileError"></div>
                                                      
                                                      <% } else { %>
                                                        <p>Access to file uploads is <b style="color: var(--tz-form-invalid-color);">restricted</b></p>
                                                      <% } %>
                                                      
                                                      
                                                   
                                                    </div>
                                                    
                                                 </div>
                                                 <div>
                                                 <div style="margin-top: 40px;">
                                                    <% if (resultDate > currentDate) { %>
                                                 <button class="btn btn-primary btn-sm waves-effect waves-light" id="submitBtn" type="submit">Submit</button>
                                                 <% } %>
                                                  
                                                </div>

                                                <% const date4 = new Date(); %> 
                                                    
                                                <!-- <%= date4 %> -->
                                                <% const currentdate = `${date4.getFullYear()}-${(date4.getMonth() + 1).toString().padStart(2, '0')}-${date4.getDate().toString().padStart(2, '0')}`; %> 
                                                <% const date6 = new Date(leave.start_date);
                                                const start_Date = `${date6.getFullYear()}-${(date6.getMonth() + 1).toString().padStart(2, '0')}-${date6.getDate().toString().padStart(2, '0')}`; %>
    
                                                <% let date5 = new Date(leave.refresh_date); %>
                                                <% let leaveDate = `${date5.getFullYear()}-${(date5.getMonth() + 1).toString().padStart(2, '0')}-${(date5.getDate()).toString().padStart(2, '0')}`; %> 
                                               <!-- <%= date6 %> -->
                                               <div class="load_set_remainder" >
                                                <% if (resultDate > currentDate && leave.status == 'pending' && leaveDate != currentdate && date4 <= date6  ) { %>
                                                    <div class="d-flex justify-content-center mrg-style-1 ">
                                                 
                                                        
                                                    <% }else{ %>
                                                
                                                        <div class="d-flex justify-content-center mt-2  load_set_remainder">
    
                                                   <% } %>
                                               
    
                                                  
                                                  
                                                    <% if(leave.status == 'pending' && leaveDate != currentdate && date4 <= date6   ) { %>
                                                        <button type="button" class="set_button btn btn-primary btn-sm set-button-action1 waves-effect waves-light" data-toggle="modal" data-target="#exampleModal">Set Remainder</button>
                                                    <% } %>
                                                </div>
                                            
                                          </div>
                                           
                                           
                                            </div>
                                           
                                             <% } %>

                                      
                                         <% if(count == 3){%>
                                            <div>
                                                <div>
                                                    <p class="head-fp pt-1">Document URL
                                                    </p>
                                                    <p class="sp" id="updateShow-119">
                                                        <div class="image-container-file-upload">
                                                            <% medical_document.forEach(leave => { %>
                                                                <% let filename = leave.document_url;
                                                                    let lastDotIndex = filename.lastIndexOf('.');
                                                                    let extension = filename.substring(lastDotIndex + 1).toLowerCase(); %>
                                                    
                                                                <% if (extension === 'jpg' || extension === 'png' || extension === 'jpeg') { %>
                                                                    <a href="https://hr.shiftwave.com/assets/uploads/<%= leave.document_url.trim() %>" target="_blank">
                                                                        <p><img src="https://hr.shiftwave.com/assets/uploads/<%= leave.document_url.trim() %>"></p>
                                                                    </a>
                                                                <% } %>
                                                    
                                                                <% if (extension === 'pdf') { %>
                                                                    <a href="https://hr.shiftwave.com/assets/uploads/<%= leave.document_url %>" target="_blank">
                                                                        <p><img src="https://hr.shiftwave.com/assets/images/pdf_icon.png"></p>
                                                                    </a>
                                                                <% } %>
                                                    
                                                                <% if (extension === 'doc' || extension === 'xlxs' || extension === 'xls' || extension === 'docx' || extension === 'txt') { %>
                                                                    <a href="https://hr.shiftwave.com/assets/uploads/<%= leave.document_url %>" download>
                                                                        <p><img src="https://hr.shiftwave.com/assets/images/word-doc-icn.png"></p>
                                                                    </a>
                                                                <% } %>
                                                            <% }) %>
                                                        </div>
                                                    </p>
                                                    
                                                    
                                                    
                                                   
                                                                
                                                 </div>
                                                 <div class="d-flex justify-content-center mrg-style-1 load_set_remainder">

                                                    <% const date4 = new Date(); %> 
                                                    
                                                    <!-- <%= date4 %> -->
                                                    <% const currentdate = `${date4.getFullYear()}-${(date4.getMonth() + 1).toString().padStart(2, '0')}-${date4.getDate().toString().padStart(2, '0')}`; %> 
                                                    <% const date6 = new Date(leave.start_date);
                                                    const start_Date = `${date6.getFullYear()}-${(date6.getMonth() + 1).toString().padStart(2, '0')}-${date6.getDate().toString().padStart(2, '0')}`; %>
        
                                                    <% let date5 = new Date(leave.refresh_date); %>
                                                    <% let leaveDate = `${date5.getFullYear()}-${(date5.getMonth() + 1).toString().padStart(2, '0')}-${(date5.getDate()).toString().padStart(2, '0')}`; %> 
                                                   <!-- <%= date6 %> -->
                                                 
                                                    <% if(leave.status == 'pending' && leaveDate != currentdate && date4 <= date6   ) { %>
                                                        <button type="button" class="set_button btn btn-primary mt-3 set-button-action1 btn-sm waves-effect waves-light" data-toggle="modal" data-target="#exampleModal">Set Remainder</button>
                                                    <% } %>
                                                </div>
                                                 
                                                
                                             </div>
                                          
                                            <% } %>

                                         

                                         

                                           



                                         </div>
                                    </div>
                                    <% if(count != 3 && count != 2){%> 
                                        <div class="d-flex justify-content-center  load_set_remainder">
    
                                            <% const date4 = new Date(); %> 
                                            
                                            <!-- <%= date4 %> -->
                                            <% const currentdate = `${date4.getFullYear()}-${(date4.getMonth() + 1).toString().padStart(2, '0')}-${date4.getDate().toString().padStart(2, '0')}`; %> 
                                            <% const date6 = new Date(leave.start_date);
                                            const start_Date = `${date6.getFullYear()}-${(date6.getMonth() + 1).toString().padStart(2, '0')}-${date6.getDate().toString().padStart(2, '0')}`; %>
    
                                            <% let date5 = new Date(leave.refresh_date); %>
                                            <% let leaveDate = `${date5.getFullYear()}-${(date5.getMonth() + 1).toString().padStart(2, '0')}-${(date5.getDate()).toString().padStart(2, '0')}`; %> 
                                           <!-- <%= date6 %> -->
                                          
                                            <% if(leave.status == 'pending' && leaveDate != currentdate && date4 <= date6   ) { %>
                                                <button type="button" class="set_button btn btn-primary mt-2 set-button-action1 btn-sm waves-effect waves-light" data-toggle="modal" data-target="#exampleModal">Set Remainder</button>
                                            <% } %>
                                        </div>
                                        
                                        
                                        <% } %>
                                </div>
                                
                            </div>
                        </div>
                        <% }) %>
                        <!-- Striped table end -->

                    </div>


                </div> <!-- container -->

            </div> <!-- content -->

            <!-- Footer Start -->
            <%- include('../../includes/employee-footer')%>
                <!-- end Footer -->

        </div>
    </div>
    <!-- END wrapper -->

    <!-- Theme Settings -->
    <%- include('../../includes/employee-theme')%>

    <!-- ... (previous HTML code) ... -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {

        $('.delete_button').on('click', function () {
                    const reqIdValue = $('#req_id').text().trim(); 
                    const perIdValue = $('#permission_id').text().trim(); 

                    if (confirm('Are you sure you want to proceed?')) {
                        if (reqIdValue || perIdValue) {
                            const dataToSend = {}; 

                            if (reqIdValue) {
                                dataToSend.request_id = reqIdValue;
                            }

                            if (perIdValue) {
                                dataToSend.permission_id = perIdValue;
                            }

                            $.ajax({
                                url: '/leave/deleteLeave',
                                type: 'POST',
                                data: dataToSend, // Dynamically send data
                                success: function (response) {
                                    alert(response.message); 
                                    
                                },
                                error: function (xhr, status, error) {
                                    alert('Error: ' + error);
                                }
                            });
                        } else {
                            alert('No valid ID found to delete!');
                        }
                    } else {
                        alert('Action cancelled!');
                    }
                });



        // set button
        $('.set_button').on('click',function () {



    let req_id=$('#req_id').text();
     $.ajax({
    type: 'POST',
    dataType: "json",
    data: {req_id:req_id,leavehistory:1},
    url: '/leave/set-remainder',
    success: function (response) { 
    
        if (response.status == "success") {

            text="Do you want to send a reminder email to HR? Click the button ok";
            if (confirm(text) == true) {
               
                $("#sucess_message").text("Reminder Email to HR has been successfully sent");
                $("#sucess_message").show().fadeOut(6000);
                $("html, body").animate({ scrollTop: 0 }, "slow");
                $(".load_set_remainder").load(window.location.href + " #load_set_remainder");  
            }
           
        }else{
        alert("not remainder sucessfully")
        }
    }
    });



    })

        



        $('#submitBtn').on('click', function (event) {
            event.preventDefault(); // Prevent form submission
            
            $("#fileError").text("");
            const fileInput = $('#validationCustom04')[0];
            
            const formData = new FormData();

            if (fileInput.files.length > 0) {  
                
                if (fileInput.files.length <= 5) {
                    
                    $('#failed-message').hide();

for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('image[]', fileInput.files[i]);
    }

    $('#submitBtn').html(`
<div class="spinner-border spinner-border-sm" role="status">
<span class="visually-hidden">Loading...</span>
</div>`);

$.ajax({
    type: 'POST',
    dataType: "json",
    processData: false, 
    contentType: false,
    data: formData,
    url: 'https://www.shiftwave.com/node-upload.php',
    success: function (response) { 
        formData.append('leaveDetails','leaveDetails');
        formData.append('req_id', $('#req_id').text());
        formData.append('filelength', response.length);
        formData.append('filenames', response);
        let filelength= response.length;
        let filenames = response;
        $.ajax({
            type: 'POST',
            dataType: "json",
            processData: false,
            contentType: false,
            data: formData,
            url: '/leave/uploadFile',
            success: function (response) {
                                
                if (response.status == 'Successfully created') {
                    
                
if (response.documentURL && response.documentURL.length > 0) {


let htmlContent = "<p class='head-fp'>Document URL</p> <div class='image-container-file-upload'>";

response.documentURL.forEach((url) => {
const fileName = url.split('/').pop(); // Extract the file name from the URL
htmlContent += `${getFileTypeLink(url, fileName)}`;
});

htmlContent += "</div></p>";

$("#file").html(htmlContent);



}


function getFileTypeLink(url, fileName) {
const lastDotIndex = fileName.lastIndexOf('.');
const fileExtension = lastDotIndex !== -1 ? fileName.substring(lastDotIndex + 1).toLowerCase() : '';

switch (fileExtension) {
case 'pdf':
return `<a href="https://hr.shiftwave.com/assets/uploads/${url}" target="_blank"><img style="width: 100px; height: 100px;margin-right: 10px;" src="https://hr.shiftwave.com/assets/images/pdf_icon.png"></a>`;
case 'jpg':
case 'jpeg':
case 'png':
return `<a href="https://hr.shiftwave.com/assets/uploads/${url}" target="_blank"><p><img src="https://hr.shiftwave.com/assets/uploads/${url.trim()}"></p></a>`;
case 'doc':
case 'xlxs':
case 'xls':
case 'docx':
case 'txt':
return `<a href="https://hr.shiftwave.com/assets/uploads/${url}" download><p><img src="https://hr.shiftwave.com/assets/images/word-doc-icn.png"></p></a>`;
default:
return `<a href="https://hr.shiftwave.com/assets/uploads/${url}" target="_blank"></a>`;
}
}

                                                        
                    $('#failed-message').text('');
                    $('#failed-message').removeClass('alert-primary');
                    $('#failed-message').hide();
                    $('#sucess_message').text("Document Update Successfully");
                    $('#sucess_message').show();
                    $('#leaveForm').removeClass('was-validated');
                    $('.invalid-feedback').hide();
                    $('.form-control').removeClass('is-invalid');
                 
                    $('#half-day').hide();
                    $('#noofdays').hide();
                } else {                        
                    $('#failed-message').text(response.status);
                    $('#failed-message').show();
                }
            }
        });
    }
});

                }else{

                    $("#fileError").text("Maximum of 5 files can be uploaded");
                  event.preventDefault();
                  $('#failed-message').hide();
                  return
                }
                
               
            } else {
                // Display a message if no file is selected
                $('#failed-message').addClass('invalid-feedback')
                $('#failed-message').show();
            }
        });
    });

    
</script>



  


   

    <!-- Vendor js -->
    <script src="/assets/js/vendor.min.js"></script>

    <!-- Daterangepicker js -->
    <script src="/assets/vendor/daterangepicker/moment.min.js"></script>
    <script src="/assets/vendor/daterangepicker/daterangepicker.js"></script>

    <!-- Apex Charts js -->

    <!-- Vector Map js -->
    <script src="/assets/vendor/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.min.js"></script>
    <script src="/assets/vendor/admin-resources/jquery.vectormap/maps/jquery-jvectormap-world-mill-en.js"></script>





    <!-- App js -->
    <script src="/assets/js/app.min.js"></script>

</body>

</html>